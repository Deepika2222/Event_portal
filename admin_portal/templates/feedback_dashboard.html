{% extends "base.html" %}
{% block title %}Feedback Dashboard{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
    <div>
        <p class="text-uppercase text-muted small mb-1">Insights</p>
        <h1 class="h3 mb-0">Feedback Dashboard</h1>
    </div>
    <div class="btn-group">
        <a class="btn btn-outline-primary" href="{{ url_for('events_dashboard') }}">Events dashboard</a>
        <a class="btn btn-outline-secondary" href="{{ url_for('export_feedback') }}">Export CSV</a>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="stat-card bg-info text-white">
            <p class="mb-1">Feedback entries</p>
            <h2>{{ stats.total }}</h2>
            <small class="text-white-50">{{ rating_filter|title or 'All ratings' }}</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card bg-success text-white">
            <p class="mb-1">Average rating</p>
            <h2>{{ stats.avg_rating or '—' }}</h2>
            <small class="text-white-50">out of 5</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card bg-warning text-dark">
            <p class="mb-1">Positive share</p>
            <h2>{{ stats.positive_pct }}%</h2>
            <small class="text-muted">ratings ≥ 4</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card bg-dark text-white">
            <p class="mb-1">Trending event</p>
            {% if stats.trending_event %}
                <h6 class="mb-0">{{ stats.trending_event[0] }}</h6>
                <small class="text-white-50">{{ stats.trending_event[1] }} comments</small>
            {% else %}
                <h6 class="mb-0">—</h6>
                <small class="text-white-50">No data</small>
            {% endif %}
        </div>
    </div>
</div>

<form class="row g-2 mb-4" method="get">
    <div class="col-md-9">
        <div class="btn-group" role="group">
            <input type="radio" class="btn-check" name="rating" id="rating-all" value="" {% if not rating_filter %}checked{% endif %}>
            <label class="btn btn-outline-secondary" for="rating-all">All</label>
            <input type="radio" class="btn-check" name="rating" id="rating-good" value="good" {% if rating_filter == 'good' %}checked{% endif %}>
            <label class="btn btn-outline-secondary" for="rating-good">Positive (4-5)</label>
            <input type="radio" class="btn-check" name="rating" id="rating-average" value="average" {% if rating_filter == 'average' %}checked{% endif %}>
            <label class="btn btn-outline-secondary" for="rating-average">Neutral (3)</label>
            <input type="radio" class="btn-check" name="rating" id="rating-poor" value="poor" {% if rating_filter == 'poor' %}checked{% endif %}>
            <label class="btn btn-outline-secondary" for="rating-poor">Needs attention (1-2)</label>
        </div>
    </div>
    <div class="col-md-3 d-flex gap-2">
        <button class="btn btn-primary flex-fill" type="submit">Apply filter</button>
        <a class="btn btn-outline-secondary flex-fill" href="{{ url_for('feedback_dashboard') }}">Reset</a>
    </div>
</form>

<div class="row g-4">
    <div class="col-lg-4">
        <div class="card shadow-sm h-100">
            <div class="card-header">Rating distribution</div>
            <div class="card-body">
                {% for rating in range(5, 0, -1) %}
                <div class="mb-3">
                    <div class="d-flex justify-content-between small text-muted">
                        <span>{{ rating }} stars</span>
                        <span>{{ rating_distribution[rating] }}</span>
                    </div>
                    <div class="progress" style="height: 6px;">
                        {% set total = stats.total or 1 %}
                        {% set percent = (rating_distribution[rating] / total * 100) if stats.total else 0 %}
                        <div class="progress-bar progress-fill" style="--progress: {{ percent }}"></div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    <div class="col-lg-8">
        <div class="card shadow-sm h-100">
            <div class="card-header">Latest feedback</div>
            <div class="table-responsive">
                <table class="table align-middle mb-0">
                    <thead>
                        <tr>
                            <th>Event</th>
                            <th>Student</th>
                            <th>Rating</th>
                            <th>Comment</th>
                            <th>Submitted</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if feedback %}
                            {% for row in feedback %}
                            <tr>
                                <td>{{ row.event_name }}</td>
                                <td>
                                    <div class="fw-semibold">{{ row.student_name }}</div>
                                    <small class="text-muted">USN {{ row.USN }}</small>
                                </td>
                                <td>
                                    <span class="badge bg-warning text-dark">{{ row.rating }}/5</span>
                                </td>
                                <td style="max-width: 320px;">
                                    <small>{{ row.comment or '—' }}</small>
                                </td>
                                <td>{{ row.submitted_at }}</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr><td colspan="5" class="text-center py-4">No feedback available.</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}
